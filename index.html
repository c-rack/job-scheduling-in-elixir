<!doctype html>
<html lang="en">

  <head>
    <meta charset="utf-8">

    <title>Job Scheduling in Elixir</title>

    <meta name="description" content="A framework for easily creating beautiful presentations using HTML">
    <meta name="author" content="Constantin Rack">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">

    <link rel="stylesheet" href="css/reveal.css">
    <link rel="stylesheet" href="css/theme/moon.css" id="theme">

    <!-- Code syntax highlighting -->
    <link rel="stylesheet" href="lib/css/zenburn.css">

    <!-- Printing and PDF exports -->
    <script>
      var link = document.createElement( 'link' );
      link.rel = 'stylesheet';
      link.type = 'text/css';
      link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
      document.getElementsByTagName( 'head' )[0].appendChild( link );
    </script>

    <!--[if lt IE 9]>
    <script src="lib/js/html5shiv.js"></script>
    <![endif]-->
 
  </head>

  <body>

    <div class="reveal">

      <div class="slides">

        <section>
          <h1>Job scheduling<br>in Elixir</h1>
          <h3>Constantin Rack</h3>
          <p>
            <a href="https://twitter.com/ConstantinRack">@ConstantinRack</a>
            |
            <a href="https://github.com/c-rack">github.com/c-rack</a>
          </p>
          <p>
            <a href="http://elixir.ruhr/">elixir.ruhr</a> | 11.02.2016 | Bochum, Germany
          </p>
        </section>

        <section>
          <h2>Problem</h2>
          <section>
            <p class="fragment">How to execute tasks periodically?</p>
            <p class="fragment"><i>Backups, health checks, newsletters, cleanup, &hellip;</i></p>
          </section>
        </section>
        
        <section>
          <h2>Solutions</h2>
          <section>
            <ul>
              <li class="fragment">System: <i>
                <a href="https://en.wikipedia.org/wiki/Cron">cron</a>,
                <a href="https://en.wikipedia.org/wiki/Anacron">anacron</a>,
                <a href="http://fcron.free.fr/">fcron</a>,
                <a href="https://expl.info/display/HCRON/Home">hcron</a>,
                <a href="https://github.com/dshearer/jobber">jobber</a>
                </i>
              <li class="fragment">Frameworks: <i>
                <a href="https://quartz-scheduler.org/">quartz</a>,
                <a href="https://mesos.github.io/chronos/">chronos</a></i>
              <li class="fragment">Erlang libraries: <i>
                <a href="https://github.com/erlware/erlcron">erlcron</a>,
                <a href="https://github.com/jeraymond/leader_cron">leader_cron</a>,
                <a href="https://github.com/b3rnie/crontab">crontab</a></i>
              <li class="fragment">Native Elixir implementation
              <li class="fragment">Elixir library: <i>
                <a href="https://github.com/c-rack/quantum-elixir">quantum</a></i>
            </ul>
          </section>
        </section>
        
        <section>
          <h2>Erlang / Elixir Process</h2>
          <img class="plain fragment" src="./process1.png">
        </section>
        
        <section>
          <h2>Process Communication</h2>
          <img class="plain fragment" src="./process2.png">
        </section>
        
        <section>
          <h2>Supervision</h2>
          <img class="plain fragment" src="./process3.png">
        </section>

        <section>
          <h2>Start from scratch</h2>
          <pre><code class="hljs stretch fragment">
            defmodule PeriodicTask do
            
              use GenServer
            
              def init(state) do
                Process.send_after(self, :tick, 1000)
                {:ok, state}
              end
            
              def handle_info(:tick, state) do
                Process.send_after(self, :tick, 1000)
                IO.puts "Executing every second"
                {:noreply, state}
              end
            
            end

            # GenServer.start_link(PeriodicTask, nil)
          </code></pre>
        </section>

        <section>
          <h2>Demo</h2>
          <h3>Simple periodic task</h3>
        </section>
        
        <section>
          <h2>Recap: cron expressions</h2>
          <table class="fragment">
            <thead>
              <tr>
                <th>Meaning</th>
                <th>Allowed</th>
                <th>Examples</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>Minute</td>
                <td>0 - 59</td>
                <td>* | 0 | 0-5 | 0,30 | */15</td>
              </tr>
              <tr>
                <td>Hour</td>
                <td>0 - 23</td>
                <td>* | 0 | 0-5 | 0,5 | */2</td>
              </tr>
              <tr>
                <td>Day of month</td>
                <td>1 - 31</td>
                <td>* | 1 | 1-5 | 1,5 | */2</td>
              </tr>
              <tr>
                <td>Month</td>
                <td>1 - 12</td>
                <td>* | 1 | 1-5 | 1,5 | jan-may</td>
              </tr>
              <tr>
                <td>Day of week</td>
                <td>0 - 6</td>
                <td>* | 0 | 1-5 | 1,5 | mon-fri</td>
              </tr>
            </tbody>
          </table>          
        </section>

        <section>
          <h2>Demo</h2>
          <h3>quantum</h3>
        </section>

	<section>
	  <h2>Components</h2>
	  <ul>
		  <li>executor</li>
		  <li>job</li>
		  <li>matcher</li>
		  <li>normalizer</li>
		  <li>parser</li>
		  <li>timer</li>
		  <li>translator</li>
          </ul>
  	</section>
    	  <section>
          <h2>Beautiful Elixir #1</h2>
          <b>Normalize cron expressions</b>
          <pre><code class="hljs stretch fragment">

  defmodule Quantum.Translator do

    def translate(s) do
      {s, _} = List.foldl ~w{sun mon tue wed thu fri sat}, {s, 0},
               fn n, acc -> do_translate acc, n end
      s
    end

    defp do_translate({s, i}, n) do
      {String.replace(s, n, "#{i}"), i + 1}
    end

  end
  
  # iex(1)> "mon-fri" |> Quantum.Translator.translate
  # "1-5"
          </code></pre>
        </section>

        <section>
          <h2>Beautiful Elixir #2</h2>
          <b>Macros</b>
          <pre><code class="hljs stretch fragment">
  defmodule Quantum.Timer do

    now = case Application.get_env(:quantum, :timezone, :utc) do
      :utc ->     &:calendar.now_to_universal_time/1
      :local ->   &:calendar.now_to_local_time/1
      timezone -> raise "Unsupported timezone: #{timezone}"
    end

    def tick do
      {d, {h, m, s}} = unquote(now).(:os.timestamp)
      Process.send_after(self, :tick, (60 - s) * 1000)
      {d, h, m}
    end

  end
          </code></pre>
        </section>

        <section>
          <h1>Thanks!</h1>
          <p>
            <a href="https://twitter.com/ConstantinRack">@ConstantinRack</a>
            |
            <a href="https://github.com/c-rack">github.com/c-rack</a>
          </p>
        </section>

      </div>

    </div>

    <script src="lib/js/head.min.js"></script>
    <script src="js/reveal.js"></script>

    <script>

      // Full list of configuration options available at:
      // https://github.com/hakimel/reveal.js#configuration
      Reveal.initialize({
        controls: true,
        progress: true,
        history: true,
        center: true,

        transition: 'slide', // none/fade/slide/convex/concave/zoom

        // Optional reveal.js plugins
        dependencies: [
          { src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
          { src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
          { src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
          { src: 'plugin/highlight/highlight.js', async: true, callback: function() {
            hljs.configure({
              languages: ['elixir']
            });
            hljs.initHighlightingOnLoad(); } },
          { src: 'plugin/zoom-js/zoom.js', async: true },
          { src: 'plugin/notes/notes.js', async: true }
        ]
      });

    </script>

  </body>
</html>
